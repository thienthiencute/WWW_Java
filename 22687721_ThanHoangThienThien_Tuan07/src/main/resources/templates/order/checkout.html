<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Thanh toán</title>
    <meta charset="UTF-8"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
<div class="container py-5">
    <h2 class="mb-4">Thanh toán</h2>

    <div class="row">
        <div class="col-md-8">
            <h4>Thông tin đơn hàng</h4>
            <table class="table table-bordered">
                <thead class="table-light">
                <tr>
                    <th>Sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Thành tiền</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${cart.items}">
                    <td th:text="${item.product.name}"></td>
                    <td th:text="${item.quantity}"></td>
                    <td th:text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 2, 'POINT')} + ' VNĐ'"></td>
                </tr>
                </tbody>
                <tfoot>
                <tr class="table-success">
                    <td colspan="2" class="text-end fw-bold">Tổng cộng:</td>
                    <td th:text="${#numbers.formatDecimal(cart.total, 0, 'COMMA', 2, 'POINT')} + ' VNĐ'" class="fw-bold"></td>
                </tr>
                </tfoot>
            </table>
        </div>

        <div class="col-md-4">
            <h4>Thông tin khách hàng</h4>
            <form id="checkoutForm" th:action="@{/orders/checkout}" method="post">
                <div class="mb-3">
                    <label class="form-label">Chọn khách hàng:</label>
                    <select name="customerId" class="form-select" required>
                        <option value="">-- Chọn khách hàng --</option>
                        <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.name}"></option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success w-100">
                    <i class="fas fa-shopping-cart"></i> Đặt hàng
                </button>
                <a th:href="@{/orders/cart}" class="btn btn-secondary w-100 mt-2">
                    <i class="fas fa-arrow-left"></i> Quay lại giỏ hàng
                </a>
            </form>
        </div>
    </div>
</div>

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.getElementById('checkoutForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = this;
        const customerId = form.querySelector('select[name="customerId"]').value;

        if (!customerId) {
            Swal.fire({
                icon: 'warning',
                title: 'Chưa chọn khách hàng',
                text: 'Vui lòng chọn khách hàng!',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        // Gửi form
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form)
        })
            .then(response => {
                if (response.ok || response.redirected) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Đặt hàng thành công!',
                        text: 'Cảm ơn bạn đã mua hàng.',
                        confirmButtonColor: '#28a745',
                        timer: 2000,
                        timerProgressBar: true
                    }).then(() => {
                        window.location.href = '/products';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Đặt hàng thất bại',
                        text: 'Vui lòng thử lại!',
                        confirmButtonColor: '#dc3545'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Có lỗi xảy ra',
                    text: 'Vui lòng thử lại sau!',
                    confirmButtonColor: '#dc3545'
                });
            });
    });
</script>
</body>
</html>